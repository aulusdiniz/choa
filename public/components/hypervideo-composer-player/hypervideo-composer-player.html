<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../components/subvideo-composer/subvideo-composer.html">
<link rel="import" href="../../components/subvideo-composer/upload-item.html">
<link rel="import" href="../../components/question-composer/question-composer.html">
<link rel="import" href="../../components/subvideo-node/subvideo-node.html">
<link rel="import" href="../../components/question-node/question-node.html">
<link rel="import" href="../../components/connection-node/connection-node.html">


<dom-module id="hypervideo-composer-player">
  <style is="custom-style">
    #video {
      width: 100%;
      max-height: 30em;
      min-height: 20em;
      z-index: -100;
      background-size: cover;
      background: black;
      overflow: hidden;
    }
    #videoFrame {
      position: absolute;
      top: 100px;
      bottom: 10px;
      left: 10px;
      right: 10px;
    }
    .options {
      position: relative;
      width: 120%;
    }
    #hypervideoName {
      width: 50%;
      margin-left: 15%;
      float: left;
    }
    .box {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .box .row.content {
      flex: 1 .01 auto;
    }
    .box .row.footer {
      flex: 0 1 auto;
      min-height: 80px;
      overflow: hidden;
    }
    #fileInputArea {
      color: transparent;
      position: relative;
      width: 100%;
      height: 100%;
      background-color:rgba(220,220,220,0);/*var(--light-divider-color);*/
      overflow: hidden;
    }
    #inputfile{
      opacity: 0;
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 2;
    }
    #hint-text {
      position: absolute;
      left: 10px;
      top: 10px;
      right: 10px;
      bottom: 10px;
      background-color:rgba(220,220,220,0.2);/*var(--light-divider-color);*/
      color: rgba(200,200,200,1);/*var(--light-divider-color);*/
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      z-index: 0;
    }
    #hint-text span {
      position: absolute;
      width: 200px;
      left: 50%;
      top: 50%;
      margin:-20px 0 0 -100px;
    }
    .left {
      float: left;
      margin: 0;
    }
    .toggleDrawer {
      margin: 5px 0 0 10px;
      width: auto;
      font-size: 11px;
      height: 30px;
      line-height: 15px;
    }
  </style>
  <template>
    <paper-drawer-panel id=annotationDrawer drawer-width="50%">
      <div drawer>
        <div class="box">
          <div class="row content">
            <!-- Here will be displayed uploaded videos -->
            <ul class="list-inline left">
              <li>
                <paper-button class="toggleDrawer"
                on-tap="toggleAnnotationDrawer">
                Adicionar um trecho de video na trilha
                </paper-button>
              </li>
              <li>
                <paper-button class="toggleDrawer"
                on-tap="toggleAnnotationDrawer">
                Adicionar um trecho de video em quadro sobre pondo a tela
                </paper-button>
              </li>
              <li>
                <paper-button class="toggleDrawer"
                on-tap="toggleAnnotationDrawer">
                Adicionar um trecho para mostrar imagem sobre algum lugar do video
                </paper-button>
              </li>
              <li>
                <paper-button class="toggleDrawer"
                on-tap="toggleAnnotationDrawer">
                Adicionar indice de capítulos ao vídeo
                </paper-button>
              </li>
                <paper-button class="toggleDrawer"
                on-tap="toggleAnnotationDrawer">
                +Anotação
                </paper-button>
              </li>
              <li>
                <paper-button class="toggleDrawer"
                on-tap="toggleAnnotationDrawer">
                +Detalhes das Anotações
                </paper-button>
              </li>
            </ul>
            <template id="files" is="dom-repeat" items="{{fileObjects}}" as="videoFile">
              <upload-item file="{{videoFile}}" on-upload-complete="handleUploadComplete"></upload-item>
            </template>
            <template id="subvideos" is="dom-repeat" items="{{subvideoNodes}}" as="subvideoNode">
              <subvideo-composer subvideo="{{subvideoNode.subvideo}}"></subvideo-composer>
            </template>
          </div>
          <div id="fileInputArea" class="row footer">
            <input id="inputfile" type="file" multiple accept="video/*" on-change="loadFiles"></input>
            <div id="hint-text">
              <span>
                Este será o painel para escolha das anotações.
              </span>
            </div>
          </div>
        </div>
      </div>
      <div main>
        <paper-drawer-panel id=annotationDetailDrawer drawer-width="50%">
          <div drawer>
            <div class="box">
              <div class="row content">
                <!-- Here will be displayed annotation details -->
                <!-- Change this template question-composer for adapt to the annotation details. -->
                <template id="questions" is="dom-repeat" items="{{questionNodes}}" as="questionNode">
                  <question-composer question="{{questionNode.question}}"></question-composer>
                </template>
              </div>
              <div id="fileInputArea"
                class="row footer"
                on-tap="createQuestion">
                <div id="hint-text">
                  <span>
                    Este será o painel de detalhes da anotação.
                  </span>
                </div>
              </div>
            </div>
          </div>
          <!-- here start the panel header -->
          <div main>
            <div class="options">
              <ul class="list-inline left">
                <li>
                  <paper-button class="toggleDrawer"
                  on-tap="toggleAnnotationDrawer">+Anotação</paper-button>
                </li>
                <li>
                  <paper-button class="toggleDrawer"
                  on-tap="toggleAnnotationDetailDrawer">+Detalhes das Anotações</paper-button>
                </li>
              </ul>
              <paper-input id="hypervideoName"
                name="name"
                label="Nome do Hypervideo"
                value="{{hypervideo.name}}"
                on-change="updateHypervideo">
              </paper-input>
            </div>
            <!-- here start the video player content -->
            <div id="videoFrame">
              <video id="video" controls autoplay name="media">
                <source src="none" type="video/mp4">
              </video>
            </div>
            <div id="annotationOverlapFrame">
              <!-- this is where annotations will be displayed -->
            </div>
          </div>
        </paper-drawer-panel>
      </div>
    </paper-drawer-panel>
  </template>
  <script>
    Polymer({
//============================= Polymer Methods ==============================//
      is: 'hypervideo-composer-player',
      properties: {
        fileObjects: {
          type: Array,
          value: function() {
              return [];
          }
        },
        filesProgress: {
          type: Array,
          value: function() {
              return [];
          }
        },

        subvideoNodes: {
          type: Array,
          value: function() {
              return [];
          }
        },

        questionNodes: {
          type: Array,
          value: function() {
              return [];
          }
        },
        hypervideo: {
          type: Object,
          value: null,
        },
        // if any node is being dragged, this
        // property handles the redraw of connections
        dragging: {
          type: Boolean,
          value: false,
          notify: true,
          observer: "draggingChanged"
        },
        connectId: {
          type: String,
          value: null,
          notify: true,
          observer: "connectIdChanged"
        },
        name: {
          type: String,
          notify: true
        }
      },
      ready: function() {
        this.firstTouch = true;
        this.$.annotationDrawer.forceNarrow = true;
        this.$.annotationDrawer.openDrawer();
        this.$.annotationDetailDrawer.forceNarrow = true;
        this.$.annotationDetailDrawer.closeDrawer();
      },
//============================= Public Methods ===============================//
      handleUploadComplete: function(e) {
        var self = this;
        var file = e.target.file;
        self._createSubvideo(file);
        var index = self.fileObjects.indexOf(file);
        this.splice('fileObjects', index, 1);
      },
      toggleAnnotationDrawer: function() {
        this.$.annotationDrawer.togglePanel();
      },
      toggleAnnotationDetailDrawer: function() {
        this.$.annotationDetailDrawer.togglePanel();
      },
      loadFiles: function(e) {
        this.files = e.target.files;
        this.fire('upload-videos');
      },
      updateHypervideo: function(e) {
        console.log(e);
        this.hypervideo.name = e.target.value;
        this.fire('name-changed');
      },
//============================= Private Methods ==============================//
      _createAnnotation: function(file) {
        //create annotation on html
      },
      _nodesCount: function() {
        var list = Polymer.dom(this).querySelectorAll('annotation-node');
        return list.length;
      },
      _nextNodePos: function() {
        var self = this;
        var i = self._nodesCount();
        var pos = {
          x: 300 + i * 70,
          y: 110 + i * 20
        };
        return pos;
      },
      _findNode: function(id) {
        var self = this;
        return Polymer.dom(self.$.annotationOverlapFrame).querySelector('#_'+id);
      }
    });
  </script>
</dom-module>
